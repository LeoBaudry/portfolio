---
// Transition.astro
---
<div id="page-transition" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 9999; pointer-events: none; display: flex; align-items: center; justify-content: center; gap: 150px; opacity: 0; transform: translateY(100%); background-color: #F3471C; overflow: hidden;">
  
  <svg class="transition-star" width="80" height="80" viewBox="0 0 92 92" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0; position: absolute;">
    <path d="M18.4346 43.7032C18.3584 45.2431 18.4108 46.788 18.5913 48.3208C13.5625 47.5162 7.45661 46.833 8.0642e-05 45.9999C7.37937 45.1754 13.4357 44.497 18.4346 43.7032ZM48.3333 72.5744C47.5033 77.7661 46.8301 84.136 46 91.9998C45.0815 84.127 44.3368 77.7514 43.4512 72.5565C45.0748 72.7062 46.7088 72.7114 48.3333 72.5744ZM18.5913 48.3208C36.0481 51.114 40.5236 55.3814 43.4512 72.5565C37.2598 71.9856 31.2244 69.3314 26.4841 64.5912C21.9219 60.029 19.2914 54.2669 18.5913 48.3208ZM43.7571 17.5672C40.8161 36.3679 36.643 40.8117 18.4346 43.7032C18.761 37.1038 21.4433 30.5989 26.4834 25.5587C31.3017 20.7404 37.4588 18.0776 43.7571 17.5672ZM73.4121 48.2883C72.7178 54.246 70.0864 60.0207 65.5159 64.5912C60.7207 69.3863 54.6 72.0459 48.3333 72.5744C51.0922 55.317 55.5917 51.082 73.4121 48.2883ZM65.5166 25.5587C70.5131 30.5553 73.1917 36.9914 73.5558 43.532C55.0498 40.4562 50.8281 36.0687 48.0764 17.5527C54.4327 18.0293 60.6558 20.698 65.5166 25.5587ZM91.9999 45.9999C84.5627 46.8217 78.4543 47.4979 73.4121 48.2883C73.5962 46.7093 73.644 45.1177 73.5558 43.532C78.5702 44.3654 84.6331 45.1045 91.9999 45.9999ZM46 0C46.7427 6.95833 47.3603 12.7338 48.0764 17.5527C46.6387 17.4449 45.1943 17.4507 43.7571 17.5672C44.5134 12.733 45.1892 6.94996 46 0Z" fill="white"/>
  </svg>

  <svg class="transition-star" width="80" height="80" viewBox="0 0 92 92" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0; position: absolute;">
    <path d="M18.4346 43.7032C18.3584 45.2431 18.4108 46.788 18.5913 48.3208C13.5625 47.5162 7.45661 46.833 8.0642e-05 45.9999C7.37937 45.1754 13.4357 44.497 18.4346 43.7032ZM48.3333 72.5744C47.5033 77.7661 46.8301 84.136 46 91.9998C45.0815 84.127 44.3368 77.7514 43.4512 72.5565C45.0748 72.7062 46.7088 72.7114 48.3333 72.5744ZM18.5913 48.3208C36.0481 51.114 40.5236 55.3814 43.4512 72.5565C37.2598 71.9856 31.2244 69.3314 26.4841 64.5912C21.9219 60.029 19.2914 54.2669 18.5913 48.3208ZM43.7571 17.5672C40.8161 36.3679 36.643 40.8117 18.4346 43.7032C18.761 37.1038 21.4433 30.5989 26.4834 25.5587C31.3017 20.7404 37.4588 18.0776 43.7571 17.5672ZM73.4121 48.2883C72.7178 54.246 70.0864 60.0207 65.5159 64.5912C60.7207 69.3863 54.6 72.0459 48.3333 72.5744C51.0922 55.317 55.5917 51.082 73.4121 48.2883ZM65.5166 25.5587C70.5131 30.5553 73.1917 36.9914 73.5558 43.532C55.0498 40.4562 50.8281 36.0687 48.0764 17.5527C54.4327 18.0293 60.6558 20.698 65.5166 25.5587ZM91.9999 45.9999C84.5627 46.8217 78.4543 47.4979 73.4121 48.2883C73.5962 46.7093 73.644 45.1177 73.5558 43.532C78.5702 44.3654 84.6331 45.1045 91.9999 45.9999ZM46 0C46.7427 6.95833 47.3603 12.7338 48.0764 17.5527C46.6387 17.4449 45.1943 17.4507 43.7571 17.5672C44.5134 12.733 45.1892 6.94996 46 0Z" fill="white"/>
  </svg>

  <svg class="transition-star" width="80" height="80" viewBox="0 0 92 92" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0; position: absolute;">
    <path d="M18.4346 43.7032C18.3584 45.2431 18.4108 46.788 18.5913 48.3208C13.5625 47.5162 7.45661 46.833 8.0642e-05 45.9999C7.37937 45.1754 13.4357 44.497 18.4346 43.7032ZM48.3333 72.5744C47.5033 77.7661 46.8301 84.136 46 91.9998C45.0815 84.127 44.3368 77.7514 43.4512 72.5565C45.0748 72.7062 46.7088 72.7114 48.3333 72.5744ZM18.5913 48.3208C36.0481 51.114 40.5236 55.3814 43.4512 72.5565C37.2598 71.9856 31.2244 69.3314 26.4841 64.5912C21.9219 60.029 19.2914 54.2669 18.5913 48.3208ZM43.7571 17.5672C40.8161 36.3679 36.643 40.8117 18.4346 43.7032C18.761 37.1038 21.4433 30.5989 26.4834 25.5587C31.3017 20.7404 37.4588 18.0776 43.7571 17.5672ZM73.4121 48.2883C72.7178 54.246 70.0864 60.0207 65.5159 64.5912C60.7207 69.3863 54.6 72.0459 48.3333 72.5744C51.0922 55.317 55.5917 51.082 73.4121 48.2883ZM65.5166 25.5587C70.5131 30.5553 73.1917 36.9914 73.5558 43.532C55.0498 40.4562 50.8281 36.0687 48.0764 17.5527C54.4327 18.0293 60.6558 20.698 65.5166 25.5587ZM91.9999 45.9999C84.5627 46.8217 78.4543 47.4979 73.4121 48.2883C73.5962 46.7093 73.644 45.1177 73.5558 43.532C78.5702 44.3654 84.6331 45.1045 91.9999 45.9999ZM46 0C46.7427 6.95833 47.3603 12.7338 48.0764 17.5527C46.6387 17.4449 45.1943 17.4507 43.7571 17.5672C44.5134 12.733 45.1892 6.94996 46 0Z" fill="white"/>
  </svg>

</div>

<script>
import { gsap } from "gsap";
import { navigate } from "astro:transitions/client";

let isAnimating = false;

document.addEventListener("click", (e) => {
  const target = e.target instanceof Element ? e.target : null;
  const link = target?.closest("a[href]");
  
  if (!link) return;
  
  const href = link.getAttribute("href");
  
  if (!href || 
      href.startsWith("http") || 
      href.startsWith("#") || 
      href.startsWith("mailto:") || 
      href.startsWith("tel:")) {
    return;
  }
  
  if (isAnimating) return;
  
  e.preventDefault();
  isAnimating = true;
  
  const overlay = document.getElementById("page-transition");
  const stars = document.querySelectorAll(".transition-star");
  
  if (!overlay || !stars.length) {
    isAnimating = false;
    return;
  }
  
  document.body.style.overflow = "hidden";
  overlay.style.pointerEvents = "auto";
  overlay.style.opacity = "1";
  
  const enterAnimation = gsap.timeline();
  
  // Overlay monte en 0.6s
  enterAnimation.fromTo(overlay, { y: "100%" }, {
    y: "0%",
    duration: 0.6,
    ease: "power3.inOut"
  });
  
  // Les 3 étoiles apparaissent superposées au centre
  enterAnimation.fromTo(stars, 
    { opacity: 0, x: 0, y: 100 },
    {
      opacity: 1,
      y: 0,
      duration: 0.6,
      ease: "power2.out"
    },
    0.1
  );
  
  // Puis elles se décalent à leur position finale
  enterAnimation.to(stars[0], {
    x: -230,
    duration: 0.6,
    ease: "back.out(1.7)"
  }, 0.5);
  
  enterAnimation.to(stars[1], {
    x: 0,
    duration: 0.6,
    ease: "back.out(1.7)"
  }, 0.5);
  
  enterAnimation.to(stars[2], {
    x: 230,
    duration: 0.6,
    ease: "back.out(1.7)"
  }, 0.5);
  
  // Délai réduit à 0.4s avant navigation
  enterAnimation.to({}, { duration: 0.4 });
  
  enterAnimation.eventCallback("onComplete", () => {
    navigate(href);
  });
}, true);

document.addEventListener("astro:after-swap", () => {
  const overlay = document.getElementById("page-transition");
  const stars = document.querySelectorAll(".transition-star");
  const pageContent = document.getElementById("page-content");
  
  if (!overlay || !stars.length) return;
  
  overlay.style.transform = "translateY(0%)";
  overlay.style.opacity = "1";
  overlay.style.backgroundColor = "#F3471C";
  overlay.style.pointerEvents = "auto";
  
  // Reset les étoiles à leur position finale écartée
  gsap.set(stars[0], { opacity: 1, x: -230, y: 0 });
  gsap.set(stars[1], { opacity: 1, x: 0, y: 0 });
  gsap.set(stars[2], { opacity: 1, x: 230, y: 0 });
  
  if (pageContent) {
    pageContent.style.filter = "blur(25px)";
  }
  
  // Délai réduit à 0.3s avant l'animation de sortie
  const exitAnimation = gsap.timeline({
    delay: 0.3,
    onComplete: () => {
      overlay.style.pointerEvents = "none";
      overlay.style.transform = "translateY(100%)";
      overlay.style.opacity = "0";
      document.body.style.overflow = "";
      if (pageContent) pageContent.style.filter = "";
      isAnimating = false;
    }
  });
  
  // Les étoiles se regroupent au centre
  exitAnimation.to(stars, {
    x: 0,
    duration: 0.2,
    ease: "power2.in"
  }, 0);
  
  // Puis disparaissent ensemble
  exitAnimation.to(stars, {
    y: 100,
    opacity: 0,
    duration: 0.5,
    ease: "power2.in"
  }, 0.3);
  
  // Overlay descend en 0.6s
  exitAnimation.to(overlay, {
    y: "-100%",
    duration: 0.6,
    ease: "power4.inOut"
  }, 0);
  
  if (pageContent) {
    exitAnimation.to(pageContent, {
      filter: "blur(0px)",
      duration: 0.8,
      ease: "power3.out"
    }, 0.3);
  }
});
</script>
