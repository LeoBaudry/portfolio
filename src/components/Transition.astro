---
// Transition.astro
---
<div id="page-transition" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 9999; pointer-events: none; display: flex; align-items: center; justify-content: center; opacity: 0; transform: translateY(100%); background-color: white; overflow: hidden;">
  <svg id="transition-logo" width="150" height="91" viewBox="0 0 500 304" fill="none" xmlns="http://www.w3.org/2000/svg" style="max-width: 40vw; opacity: 0; transform: translateY(0px);">
    <g><path d="M79.5456 201.109L89.2795 199.672L89.2859 199.829C144.763 192.558 192.502 183.459 209.416 181.371V219.374C141.149 220.32 78.8835 234.497 30.8442 257.394V30.8679C30.8442 15.2715 10.2814 3.79079 0 0H79.5456V201.109Z" fill="black"/></g>
    <g><path d="M209.416 162.437L101.876 175.46L107.142 144.592C122.778 145.097 148.567 140.518 160.713 133.706V95.041H131.493V71.4834H160.713V26.3945C150.129 22.735 126.736 22.2436 111.201 22.7451V0H209.416V162.437Z" fill="black"/></g>
    <g><path d="M339.286 234.559C304.719 225.459 266.26 220.091 225.649 219.402V0H339.286V234.559ZM274.35 195.127L290.584 197.589V19.707L274.35 19.001V195.127Z" fill="black"/></g>
    <g><path d="M500 0C489.719 3.79088 469.156 15.2719 469.156 30.8682V304C459.468 293.611 447.703 283.901 434.164 275.031C430.864 272.869 427.459 270.758 423.953 268.698C422.848 268.049 421.733 267.405 420.608 266.767C412.609 262.225 404.109 257.949 395.156 253.968C394.573 253.709 393.988 253.451 393.401 253.194C392.991 253.015 392.58 252.836 392.168 252.657V252.656C380.643 247.671 368.393 243.166 355.52 239.195V0H500ZM404.221 234.679L420.455 244.112V26.1494L404.221 25.1709V234.679Z" fill="black"/></g>
  </svg>
</div>

<script>
import { gsap } from "gsap";
import { navigate } from "astro:transitions/client";

let isAnimating = false;

// ðŸ”¥ Simple : intercepter les clics
document.addEventListener("click", (e) => {
  const link = e.target.closest("a[href]");
  
  if (!link) return;
  
  const href = link.getAttribute("href");
  
  if (!href || 
      href.startsWith("http") || 
      href.startsWith("#") || 
      href.startsWith("mailto:") || 
      href.startsWith("tel:")) {
    return;
  }
  
  if (isAnimating) return;
  
  e.preventDefault();
  isAnimating = true;
  
  const overlay = document.getElementById("page-transition");
  const logo = document.getElementById("transition-logo");
  
  document.body.style.overflow = "hidden";
  overlay.style.pointerEvents = "auto";
  overlay.style.opacity = "1";
  
  // Animation ENTRÃ‰E : rectangle monte + logo monte
  const enterAnimation = gsap.timeline();
  
  enterAnimation.fromTo(overlay, { y: "100%" }, {
    y: "0%",
    duration: 1,
    ease: "power3.inOut"
  });
  
  enterAnimation.fromTo(logo, 
    { opacity: 0, y: 100 },
    {
      opacity: 1,
      y: -80,
      duration: 0.8,
      delay: 0.2,
      ease: "power2.out"
    },
    0
  );
  
  // AprÃ¨s l'animation d'entrÃ©e, naviguer
  enterAnimation.eventCallback("onComplete", () => {
    navigate(href);
  });
}, true);

// ðŸ”¥ AprÃ¨s le swap : animation de SORTIE
document.addEventListener("astro:after-swap", () => {
  const overlay = document.getElementById("page-transition");
  const logo = document.getElementById("transition-logo");
  
  if (!overlay) return;
  
  overlay.style.transform = "translateY(0%)";
  overlay.style.opacity = "1";
  overlay.style.backgroundColor = "white";
  overlay.style.pointerEvents = "auto";
  
  logo.style.opacity = "1";
  logo.style.transform = "translateY(-80px)";
  
  const exitAnimation = gsap.timeline({
    onComplete: () => {
      overlay.style.pointerEvents = "none";
      overlay.style.transform = "translateY(100%)";
      overlay.style.opacity = "0";
      logo.style.opacity = "0";
      document.body.style.overflow = "";
      isAnimating = false;
    }
  });
  
  // Logo descend + fade out
  exitAnimation.to(logo, {
    y: 100,
    opacity: 0,
    duration: 0.8,
    ease: "power2.in"
  }, 0);
  
  // ðŸ”¥ Rectangle descend VERS LE BAS (y: "100%")
  exitAnimation.to(overlay, {
    y: "-100%",
    duration: 1,
    ease: "power3.inOut"
  }, 0);
});
</script>
