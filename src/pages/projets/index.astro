---
import pb from '@/lib/pb/pb.ts';
import Layout from '@/layouts/Layout.astro';
import ProjectsList from '@/components/graphics/ProjectsList.svelte';
import type { ProjetsResponse, TagsResponse } from '@/lib/pb/pocketbase-typegen.ts';

// Récupérer tous les projets
const projectRecords = await pb.collection('projets').getFullList<ProjetsResponse<{
  tags: TagsResponse[]
}>>({
  sort: 'created', 
  expand: 'tags'   
});

// Récupérer tous les tags pour les filtres
const tagsRecords = await pb.collection('tags').getFullList<TagsResponse>({
  sort: 'nom' 
});

// Formater les projets pour le composant Svelte
const projects = projectRecords.map(p => ({
  id: p.id,
  slug: p.slug, 
  title: p.title,
  client: p.clients,
  type: p.type_services, 
  coverImageUrl: pb.files.getURL(p, p.cover_image),
  categories: p.expand?.tags?.map(t => t.nom) || []
}));

// Formater la liste des tags pour les filtres
const allTags = ['Tous', ...tagsRecords.map(t => t.nom)];
const pageTitle = "Mes Projets";
const pageDescription = `Découvrez tous les projets de Léo Baudry. Une collection de travaux en design 3D, développement web, et UI/UX design réalisés pendant ma formation MMI.`;
---

<Layout title={pageTitle} description={pageDescription}>  
  <section class="page-content w-full px-10 lg:px-12" data-section-theme="light">
    <div class="pt-40 pb-4">
      <h1 class="text-5xl md:text-8xl font-bold text-black" style="letter-spacing: -0.05em;">
        Projets <sup>({projects.length})</sup>
      </h1>
    </div>
    
    <ProjectsList projects={projects} allTags={allTags} client:load />

  </section>
</Layout>