---
// 1. IMPORTS NÉCESSAIRES
import pb from '../../lib/pb/pb.ts';
import Layout from '../../layouts/Layout.astro';
import Icon from '../../components/ui/Icon.astro';
import LiquidGlassButton from '../../components/ui/LiquidGlassButton.astro';
import type { 
  ProjetsResponse, 
  DetailsResponse, 
  TagsResponse
} from '../../lib/pb/pocketbase-typegen.ts'; 

// GETSTATICPATHS : GÉNÈRE TOUTES LES PAGES
export async function getStaticPaths() {
  const projets = await pb.collection('projets').getFullList<ProjetsResponse<{
    tags: TagsResponse[],
    details_projet: DetailsResponse<{
      related_projects: ProjetsResponse[]
    }>
  }>>({
    expand: 'tags, details_projet, details_projet.related_projects'
  });

  return projets.map((projet) => ({
    params: { slug: projet.slug }, 
    props: { projet }              
  }));
}

// RÉCUPÉRATION DES DONNÉES
const { projet } = Astro.props;

const getImageUrl = (record: DetailsResponse<{ related_projects: ProjetsResponse[]; }> | ProjetsResponse<{
tags: TagsResponse[]; details_projet: DetailsResponse<{
related_projects: ProjetsResponse[];
}>;
}>, filename: string, fallback = '/imgs/placeholder.jpg') => {
  if (!record || !filename) return fallback;
  return pb.files.getURL(record, filename);
};

const details = projet.expand?.details_projet;

const projectData = {
  id: projet.id,
  slug: projet.slug,
  title: projet.title,
  year: projet.year,
  coverImageUrl: getImageUrl(projet, projet.cover_image),
  tags: projet.expand?.tags?.map(tag => tag.nom) || [],
  type_services: projet.type_services,
  
  // Données de la collection 'details'
  tagline: details?.tagline,
  challengeTitle: details?.challenge_title,
  challengeDescription: details?.challenge_description, 
  
  approachTitle: details?.approach_title,
  approachDescription: details?.approach_description, 

  actionsTitle: details?.actions_title,
  actionsSubtitle: details?.actions_subtitle,
  actionsDescription: details?.actions_description, 

  resultsTitle: details?.results_title,
  resultsSubtitle: details?.results_subtitle,
  resultsIntro: details?.results_intro, 
  resultsList: details?.results_list || [], // JSON
  highlights: details?.highlights || [], // JSON

  mockupImageUrl: getImageUrl(details, details?.mockup_image),

  galleryImages: details?.gallery_1?.map(img => getImageUrl(details, img)) || [],
  galleryImagesTwo: details?.gallery_2?.map(img => getImageUrl(details, img)) || [],

  // On map les projets liés (expand imbriqué)
    relatedProjects: (details && (details as any).expand && Array.isArray((details as any).expand.related_projects) ? (details as any).expand.related_projects.map((proj: any) => ({
      title: proj.title,
      slug: `/projets/${proj.slug}`,
      imageUrl: getImageUrl(proj, proj.cover_image)
    })) : [])
};
---

<Layout title={projectData.title}>
  <section class="w-full bg-white text-black">

    {/* === HERO === */}
    <div class="w-full pt-24 px-6 lg:px-12">
      <div class="relative w-full rounded-3xl overflow-hidden" style="height: 400px;">
        <img 
          src={projectData.coverImageUrl} 
          alt={projectData.title}
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-black/20"></div>
        
        <a 
          href="/projets"
          class="absolute top-6 left-6 z-20 inline-flex items-center gap-2 text-white text-sm font-medium"
        > 
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Retour aux projets
        </a>
        
        <div class="absolute bottom-6 left-6 z-20">
          <LiquidGlassButton 
            title={projectData.title}
            baseFrequency="0.012 0.025" 
            scale="25" 
            blurAmount="2px"
            bgColor="rgba(255, 255, 255, 0.05)"
          />
        </div>
        
        {projectData.tagline && (
          <div class="absolute bottom-6 right-6 z-20 max-w-xs text-right hidden md:block">
            <p class="text-white font-light text-sm">
              {projectData.tagline}
            </p>
          </div>
        )}
      </div>
    </div>

{/* === METADATA === */}
<div class="w-full">
  <div class="px-6 lg:px-12 py-6 flex flex-col md:flex-row justify-between gap-6">
    <div>
      <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Services</p>
      
      <div class="flex items-center gap-1 text-sm">
        <span class="text-black font-medium">{projectData.type_services}</span>
      </div>
      
    </div>
    <div>
      <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Année</p>
      <p class="text-lg font-bold text-black">{projectData.year}</p>
    </div>
  </div>
</div>

    {/* === DESCRIPTION SECTION === */}
    {projectData.challengeTitle && (
      <div class="w-full py-16 px-8 md:px-16 lg:px-32">
        <div class="max-w-3xl mx-auto">
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-semibold text-black mb-12 tracking-[-0.06em]">
            {projectData.challengeTitle}
          </h1>

          <div class="flex flex-col md:flex-row gap-4 md:gap-12">
            <div class="w-full md:w-1/4">
              <h2 class="text-base font-medium text-black mb-2 md:mb-0 tracking-[-0.06em]">Le défi</h2>
            </div>
            <div class="w-full md:w-3/4">
              <div class="text-sm text-gray-700 leading-relaxed max-w-prose font-light tracking-[-0.06em]" set:html={projectData.challengeDescription} />
            </div>
          </div>
        </div>
      </div>
    )}


    {/* === HIGHLIGHTS === */}
    {Array.isArray(projectData.highlights) && projectData.highlights.length > 0 && (
      <div class="w-full px-6 lg:px-12 py-16">
        <div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {projectData.highlights.map((highlight: { title: unknown; description: unknown; }) => (
              <div class="bg-gray-50 rounded-2xl p-8 lg:p-10 flex flex-col justify-end min-h-auto lg:min-h-40">
                <p class="text-4xl md:text-5xl lg:text-6xl font-semibold text-black mb-3 tracking-[-0.06em]">{highlight.title}</p>
                <p class="text-xs text-gray-500 font-medium leading-relaxed">
                  {highlight.description}
                </p>
              </div>
            ))}
          </div>
        </div>
      </div>
    )}

    {/* === MOCKUP SECTION === */}
    {projectData.mockupImageUrl && (
      <div class="w-full px-0 md:px-6 lg:px-12">
        <div class="relative flex items-center justify-center py-24 lg:py-0 lg:min-h-screen">
          <div class="absolute inset-0 items-center justify-center overflow-hidden z-0 rounded-2xl hidden lg:flex">
            <img
              src={projectData.mockupImageUrl}
              alt=""
              class="w-full h-full object-cover rounded-2xl opacity-80" 
              style="filter: blur(80px); transform: scale(1.2);" 
            />
          </div>
          <div class="relative z-10 max-w-7xl w-full px-0 md:px-4">
            <div class="rounded-2xl overflow-hidden shadow-2xl aspect-video bg-white">
              <img 
                src={projectData.mockupImageUrl}
                alt={`Mockup du projet ${projectData.title}`}
                class="w-full h-full object-cover"
              />
            </div>
          </div>
        </div>
      </div>
    )}

    {/* === APPROACH SECTION === */}
    {projectData.approachTitle && (
      <div class="py-16 px-8 md:px-16 lg:px-32">
        <div class="max-w-3xl mx-auto">
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-semibold text-black mb-12 tracking-[-0.06em]">
            {projectData.approachTitle}
          </h1>
          <div class="flex flex-col md:flex-row gap-4 md:gap-12 mb-16">
            <div class="w-full md:w-1/4">
              <h2 class="text-base font-medium text-black mb-2 md:mb-0 tracking-[-0.06em]">Mon travail</h2>
            </div>
            <div class="w-full md:w-3/4">
              <div class="text-sm text-gray-700 leading-relaxed max-w-prose font-light tracking-[-0.06em]" set:html={projectData.approachDescription} />
            </div>
          </div>
          <div class="flex justify-center">
            {projectData.galleryImages && projectData.galleryImages.length > 0 && (
              <button class="inline-flex items-center px-8 py-4 rounded-full bg-gray-100 text-black text-sm font-medium tracking-[-0.03em]">
                Concrètement, ça donne ça
                <Icon 
                  name="arrow" 
                  class="ml-5 w-3 h-3 -rotate-225" 
                  color="currentColor"
                />
              </button>
            )}
          </div>
        </div>
      </div>
    )}

    {/* === GALLERY SECTION === */}
    {projectData.galleryImages && projectData.galleryImages.length > 0 && (
      <div class="w-full px-6 lg:px-12 py-16">
        {projectData.slug === 'posters' ? (
          // Layout spécial pour les posters : grille de portraits centrée
          <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-6">
              {projectData.galleryImages.map((img, index) => (
                <div class="rounded-2xl overflow-hidden aspect-[3/4] bg-gray-100">
                  <img 
                    src={img} 
                    alt={`Poster ${index + 1}`} 
                    class="w-full h-full object-cover"
                  />
                </div>
              ))}
            </div>
          </div>
        ) : (
          // Layout original pour les autres projets
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 lg:gap-6">
            {projectData.galleryImages[0] && (
              <div class="col-span-1 md:col-span-2 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
                <img src={projectData.galleryImages[0]} alt="Galerie 1" class="w-full h-full object-cover"/>
              </div>
            )}
            {projectData.galleryImages[1] && (
              <div class="col-span-1 md:col-span-2 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
                <img src={projectData.galleryImages[1]} alt="Galerie 2" class="w-full h-full object-cover"/>
              </div>
            )}
            {projectData.galleryImages[2] && (
              <div class="col-span-1 md:col-span-2 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
                <img src={projectData.galleryImages[2]} alt="Galerie 3" class="w-full h-full object-cover"/>
              </div>
            )}
            {projectData.galleryImages[3] && (
              <div class="col-span-1 md:col-span-3 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
                <img src={projectData.galleryImages[3]} alt="Galerie 4" class="w-full h-full object-cover"/>
              </div>
            )}
            {projectData.galleryImages[4] && (
              <div class="col-span-1 md:col-span-3 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
                <img src={projectData.galleryImages[4]} alt="Galerie 5" class="w-full h-full object-cover"/>
              </div>
            )}
            {projectData.galleryImages[5] && (
              <div class="col-span-1 md:col-span-2 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
                <img src={projectData.galleryImages[5]} alt="Galerie 6" class="w-full h-full object-cover"/>
              </div>
            )}
            {projectData.galleryImages[6] && (
              <div 
                class="col-span-1 md:col-span-4 rounded-2xl overflow-hidden bg-gray-100 bg-cover bg-center"
                style={`background-image: url(${projectData.galleryImages[6]})`}
              >
                <span class="sr-only">Galerie 7</span>
              </div>
            )}
          </div>
        )}
      </div>
    )}



    {/* === ACTIONS SECTION === */}
    {projectData.actionsTitle && (
      <div class="py-16 px-8 md:px-16 lg:px-32">
        <div class="max-w-3xl mx-auto">
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-semibold text-black mb-12 tracking-[-0.06em]">
            {projectData.actionsTitle}
          </h1>
          <div class="flex flex-col md:flex-row gap-4 md:gap-12">
            <div class="w-full md:w-1/4">
              <h2 class="text-base font-medium text-black mb-2 md:mb-0 tracking-[-0.06em]" set:html={projectData.actionsSubtitle} />
            </div>
            <div class="w-full md:w-3/4">
              <div class="text-sm text-gray-700 leading-relaxed max-w-prose font-light tracking-[-0.06em]" set:html={projectData.actionsDescription} />
            </div>
          </div>
        </div>
      </div>
    )}

    {/* === GALLERY 2 === */}
    {projectData.galleryImagesTwo && projectData.galleryImagesTwo.length > 0 && (
      <div class="w-full px-6 lg:px-12 py-16">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
          {projectData.galleryImagesTwo[0] && (
            <div class="col-span-1 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
              <img src={projectData.galleryImagesTwo[0]} alt="Galerie 8" class="w-full h-full object-cover"/>
            </div>
          )}
          {projectData.galleryImagesTwo[1] && (
            <div class="col-span-1 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
              <img src={projectData.galleryImagesTwo[1]} alt="Galerie 9" class="w-full h-full object-cover"/>
            </div>
          )}
          {projectData.galleryImagesTwo[2] && (
            <div class="col-span-1 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
              <img src={projectData.galleryImagesTwo[2]} alt="Galerie 10" class="w-full h-full object-cover"/>
            </div>
          )}
          {projectData.galleryImagesTwo[3] && (
            <div class="col-span-1 rounded-2xl overflow-hidden aspect-[4/3] bg-gray-100">
              <img src={projectData.galleryImagesTwo[3]} alt="Galerie 11" class="w-full h-full object-cover"/>
            </div>
          )}
        </div>
      </div>
    )}

    {/* === RESULTS SECTION === */}
    {projectData.resultsTitle && (
      <div class="py-16 px-8 md:px-16 lg:px-32">
        <div class="max-w-3xl mx-auto">
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-semibold text-black mb-12 tracking-[-0.06em]">
            {projectData.resultsTitle}
          </h1>
          <div class="flex flex-col md:flex-row gap-4 md:gap-12">
            <div class="w-full md:w-1/4">
              <h2 class="text-base font-medium text-black mb-2 md:mb-0 tracking-[-0.06em]">
                {projectData.resultsSubtitle}
              </h2>
            </div>
            <div class="w-full md:w-3/4">
              <div class="text-sm text-gray-700 leading-relaxed max-w-prose font-light tracking-[-0.06em] mb-4" set:html={projectData.resultsIntro} />
              <ul class="list-disc list-outside space-y-2 pl-4">
                {projectData.resultsList.map((item: unknown) => (
                  <li class="text-sm text-gray-700 leading-relaxed max-w-prose font-light tracking-[-0.06em]">
                    {item}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </div>
    )}

    {/* === RELATED PROJECTS SECTION === */}
    {projectData.relatedProjects && projectData.relatedProjects.length > 0 && (
      <div class="w-full px-6 lg:px-12 py-24">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl md:text-3xl lg:text-4xl font-semibold text-black tracking-[-0.06em]">
            Vous pourriez aussi aimer
          </h2>
          <a href="/projets" class="inline-flex items-center px-4 py-2 rounded-full bg-gray-50 text-black text-xs font-medium tracking-[-0.03em]">
            Voir tous les travaux
            <Icon 
              name="arrow" 
              class="ml-2 w-3 h-3 rotate-45" 
              color="currentColor"
            />
          </a>
        </div>
        <div class="my-8 border-t border-gray-200"></div> 
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
          {projectData.relatedProjects.map((project: { slug: string | URL | null | undefined; imageUrl: string | null | undefined; title: unknown; }) => (
            <a href={project.slug} class="relative rounded-3xl overflow-hidden aspect-video group">
              <img src={project.imageUrl} alt={project.title} class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
              <div class="absolute inset-0 bg-black/10"></div>
              <div class="absolute bottom-6 left-6 z-10">
                <h3 class="text-white font-semibold text-xl">{project.title}</h3>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

  </section>
</Layout>